trigger:
  branches:
    include:
    - master
    - develop

variables:
  dockerRegistryServiceConnection: '1005146d-06b0-4566-9105-2a3f9d461171'
  containerRegistry: 'boardz.azurecr.io'
  tag: '$(Build.BuildId)'
  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build stage
  jobs:  
  - job: Build
    displayName: Build
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: Build and Push
      inputs:
        dockerfile: ./src/game-svc/Api/Dockerfile
        buildContext: ./src/game-svc
        command: buildAndPush
        repository: $(containerRegistry)/game-svc
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(Build.BuildNumber)
          latest

    - task: Docker@2
      displayName: Build and Push
      inputs:
        dockerfile: ./src/identity-server/BoardIdentityServer/Dockerfile
        buildContext: ./src/identity-server
        command: buildAndPush
        repository: $(ContainerRegistry)/identity-server
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(Build.BuildNumber)
          latest

    - task: Docker@2
      displayName: Build and Push
      inputs:
        dockerfile: ./src/frontend/Dockerfile
        buildContext: ./src/frontend
        command: buildAndPush
        repository: $(ContainerRegistry)/frontend
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(Build.BuildNumber)
          latest